{% extends "base.html" %}
{% block title %}Tambah Wajah{% endblock %}
{% block content %}

<div class="container mt-5">
    <h2 class="text-center">Tambah Wajah Baru ke Dataset</h2>
    <form class="mt-4">
        <div class="mb-3">
            <input type="text" id="name" class="form-control" placeholder="Masukkan nama orang baru" required>
        </div>
        <div class="text-center">
            <button type="button" onclick="startCamera()" class="btn btn-success">Mulai Kamera</button>
        </div>
    </form>

    <div class="text-center mt-4">
        <img id="processedFrame" width="400" height="300" class="border rounded shadow mt-3" />
    </div>

    <!-- Progress bar -->
    <div class="progress mt-4">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="20">
            0 / 20
        </div>
    </div>
</div>

<script>
    let socket;
    let frameCount = 0;
    let videoStream;
    let progress = 0;

    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoStream = stream;
                startWebSocket();
            })
            .catch(error => console.error("Error accessing camera:", error));
    }

    function startWebSocket() {
        socket = new WebSocket("ws://127.0.0.1:8000/ws");

        socket.onopen = () => console.log("WebSocket connected");
        socket.onclose = () => console.log("WebSocket closed");
        socket.onerror = (error) => console.error("WebSocket error:", error);
        
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "image") {
                document.getElementById("processedFrame").src = `data:image/jpeg;base64,${data.frame}`;
            } else if (data.type === "progress") {
                updateProgress(data.progress);
            }
        };

        sendFrames();
    }

    function sendFrames() {
        const name = document.getElementById("name").value.trim();
        if (!name) {
            alert("Masukkan nama sebelum memulai kamera!");
            return;
        }

        const video = document.createElement("video");
        video.srcObject = videoStream;
        video.play();
        
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        
        setInterval(() => {
            if (socket.readyState !== WebSocket.OPEN || progress >= 20) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (frameCount % 2 === 0) {
                canvas.toBlob(blob => {
                    blob.arrayBuffer().then(buffer => {
                        const message = {
                            type: "frame",
                            name: name,
                            image: Array.from(new Uint8Array(buffer))
                        };
                        socket.send(JSON.stringify(message));
                    });
                }, "image/jpeg");
            }

            frameCount++;
        }, 100);
    }

    function updateProgress(value) {
        progress = value;
        let progressBar = document.getElementById("progressBar");
        progressBar.style.width = `${(value / 10) * 100}%`;
        progressBar.innerText = `${value} / 10`;
    }
</script>

{% endblock %}
