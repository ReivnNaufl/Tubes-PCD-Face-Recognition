{% extends "base.html" %}
{% block title %}LBPH Face Recognition{% endblock %}
{% block content %}
    <style>
        /* Main container styling */
        .recognition-container {
            width: 100%;
            padding: 20px;
        }
        
        /* Video container with fixed size and left alignment */
        #video-wrapper {
            width: 640px;
            margin-left: 40px; /* Adjust this value to move left/right */
        }
        
        #video-container {
            position: relative;
            width: 100%;
            height: 480px;
            background: #000;
            border: 3px solid #333;
            border-radius: 5px;
            overflow: hidden;
        }
        
        /* Video element styling */
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Centered heading relative to video */
        .recognition-heading {
            width: 640px;
            text-align: center;
            margin-left: 40px; /* Must match video-wrapper margin */
            margin-bottom: 20px;
        }
        
        /* Face box styling */
        .face-box {
            position: absolute;
            border: 2px solid;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        
        .face-label {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 5px;
            font-size: 14px;
            text-align: left;
        }
        
        .recognized {
            border-color: #00FF00;
        }
        
        .unknown {
            border-color: #FF0000;
        }
    </style>

    <div class="recognition-container">
        <h1 class="recognition-heading">Live LBPH Face Recognition</h1>
        <div id="video-wrapper">
            <div id="video-container">
                <img id="video" src="" alt="Live Feed">
            </div>
        </div>
    </div>
    
    <script>
        const videoContainer = document.getElementById('video-container');
        const videoElement = document.getElementById('video');
        const ws = new WebSocket(`ws://${window.location.host}/lbph/ws`);
        
        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            const frameBytes = new Uint8Array(data.frame.match(/.{1,2}/g).map(h => parseInt(h, 16)));
            const blob = new Blob([frameBytes], { type: 'image/jpeg' });
            const url = URL.createObjectURL(blob);
            
            videoElement.src = url;
            
            // Clear previous face boxes
            document.querySelectorAll('.face-box').forEach(el => el.remove());
            
            // Draw new face boxes
            data.results.forEach(face => {
                const box = document.createElement('div');
                box.className = `face-box ${face.recognized ? 'recognized' : 'unknown'}`;
                
                box.style.left = `${face.x}px`;
                box.style.top = `${face.y}px`;
                box.style.width = `${face.w}px`;
                box.style.height = `${face.h}px`;
                
                const label = document.createElement('div');
                label.className = 'face-label';
                
                if (face.recognized) {
                    label.textContent = `${face.ethnicity} (${face.emotion}) - ${face.confidence.toFixed(1)}`;
                } else {
                    label.textContent = `Unknown (${face.confidence.toFixed(1)})`;
                }
                
                box.appendChild(label);
                videoContainer.appendChild(box);
            });
        };
        
        ws.onclose = () => console.log('WebSocket disconnected');
        ws.onerror = (error) => console.error('WebSocket error:', error);
    </script>
{% endblock %}